# Security compliance

This repo contains what is necessary to automatically scan, detect and alert users about packages impacted by vulnerabilities.

# Structure
```
security-clearance/
├── .github/
│   └── workflows/
│       └── automate_script.yml
├── data/
│   └── vulnerable_packages.json
├── notes/
│   └── info.md
├── scripts/
│   └── inspect_packages.py
│   └── dependencies.py
│   └── scrape_html_table.py
└── README.md
```
where:
- `automate_script.yml`: the workflow file used by the Github Action to automatically run the python script 
  - the workflow is scheduled to run hourly
  - it can also be triggered manually for testing purposes
- `vulnerable_packages.json`: json file containing all vulnerable packages and versions
  - this file will be the reference for the script to check whether a package is vulnerable or not
  - in this case, it was generated by `scrape_html_table.py` and contains npm packages but in general can accodomate any arbitrary packages and versions from any language
- `info.md`: an example of how this situation would be communicated to users in the company, it would be shared (e.g. via mail marked as urgent) as soon as possible  
- `inspect_packages.py`: the python script run by the Github Action, taking care of inspecting all repos in the organisation and looking for dependencies that are, the script can be read in these main parts: 
  - setup (Github token, global variables, ...)
  - `is_version_vulnerable(pkg, allowed_range)`: given a package and the allowed range, this function will compare it to the global VULNERABLE_PACKAGES dictionary and output a boolean saying if it is vulnerable
  - `create_issue(repo, vulnerable_deps)`: function to raise the Github Issue with the vulnerable dependencies as body. it will also check if there is not already an issue with the same content to avoid duplicates
  - main loop:
    1) scan all dependencies in all relevant repositories within the organization
    2) keep dependencies that are vulnerable
    3) create issue properly in the respective repositories
    4) follow up on issues older than MAXIMUM_DAYS and comment + label them
- `dependencies.py`: where we define what kind of dependencies we are looking for
  - basically a general module that is used in `inspect_packages.py` to parse dependencies
  - can be adapted to any language ecosystem by adding the proper parsing helper functions (and not forget to include the used libraries in the `automate_script.yml` 'Install Python dependencies' step)
- `scrape_html_table.py`: a script to automatically export the table in the aikido.dev website into a json file
  - can be adapted to any website containing a table with packages and versions
  - needs to be run from the parent directory `security-clearance/`
- `README.md`: what you are reading right now!

# Course of events

So what does the code do ?

1) In a scheduled (or manually triggered) Github Action, a Python script will automatically inspect at regular intervals all relevant repositories within the organization and look for all the dependencies used in each repository.
2) By comparing it to a list of known vulnerable packages (which can be either defined by hand or automatically scraped from a website), it will raise a Github Issue in respective repositories where the vulnerable packages are used, informing the users of which packages are problematic for them.
3) If the issue is not solved and closed within 1 day, the script will add a comment within that issue and label it as 'overdue'. This comment will be updated accordingly to track by how much time it is overdue. Any newly added vulnerable dependencies in the meantime will be communicated via a new issue.